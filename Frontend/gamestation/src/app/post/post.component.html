<!-- src/app/components/post/post.component.html -->
<div *ngIf="cargando">
  <p>Cargando post…</p>
</div>

<div *ngIf="!cargando" class="post-bg d-flex justify-content-center align-items-center min-vh-100">
  <div class="card post-card shadow-lg p-4" style="max-width: 600px; width: 100%; border: 3px solid #00aaff;">
    <div class="card-body">

      <!-- Botón volver gris arriba a la izquierda -->
      <div class="mb-3">
        <button type="button" class="btn btn-outline-secondary" (click)="volver()">
          &larr; Volver
        </button>
      </div>

      <h2 class="card-title text-center mb-4" *ngIf="modoEdicion; else nuevaTpl">
        Editar Post
      </h2>
      <ng-template #nuevaTpl>
        <h2 class="card-title text-center mb-4">Crear Nuevo Post</h2>
      </ng-template>

      <form [formGroup]="postForm" (ngSubmit)="onSubmit()">
        <!-- Título -->
        <div class="mb-3">
          <label class="form-label fw-bold">Título</label>
          <input class="form-control" formControlName="titulo" />
          <div *ngIf="postForm.get('titulo')?.touched && postForm.get('titulo')?.invalid" class="text-danger small mt-1">
            <div *ngIf="postForm.get('titulo')?.errors?.['required']">
              El título es obligatorio.
            </div>
          </div>
        </div>

        <!-- Subtítulo (opcional, sin validación) -->
        <div class="mb-3">
          <label class="form-label fw-bold">Subtítulo</label>
          <input class="form-control" formControlName="subtitulo" />
        </div>

        <!-- Descripción -->
        <div class="mb-3">
          <label class="form-label fw-bold">Descripción</label>
          <input class="form-control" formControlName="descripcion" />
          <div *ngIf="postForm.get('descripcion')?.touched && postForm.get('descripcion')?.invalid" class="text-danger small mt-1">
            <div *ngIf="postForm.get('descripcion')?.errors?.['required']">
              La descripción es obligatoria.
            </div>
          </div>
        </div>

        <!-- Contenido -->
        <div class="mb-3">
          <label class="form-label fw-bold">Contenido</label>
          <textarea class="form-control" formControlName="contenido" rows="8" style="min-height: 200px;"></textarea>
          <div *ngIf="postForm.get('contenido')?.touched && postForm.get('contenido')?.invalid" class="text-danger small mt-1">
            <div *ngIf="postForm.get('contenido')?.errors?.['required']">
              El contenido es obligatorio.
            </div>
            <div *ngIf="postForm.get('contenido')?.errors?.['minlength']">
              El contenido debe tener al menos {{ postForm.get('contenido')?.errors?.['minlength']?.requiredLength }} caracteres.
            </div>
          </div>
        </div>

        <!-- Fecha de publicación -->
        <div class="mb-3">
          <label class="form-label fw-bold">Fecha de publicación</label>
          <input class="form-control" formControlName="fechaPublicacion" type="date" />
          <div *ngIf="postForm.get('fechaPublicacion')?.touched && postForm.get('fechaPublicacion')?.invalid" class="text-danger small mt-1">
            <div *ngIf="postForm.get('fechaPublicacion')?.errors?.['required']">
              La fecha de publicación es obligatoria.
            </div>
          </div>
        </div>

        <!-- Tipo -->
        <div class="mb-3">
          <label class="form-label fw-bold">Tipo</label>
          <select class="form-select" formControlName="tipo">
            <option *ngFor="let t of tipos" [value]="t">{{ t }}</option>
          </select>
          <div *ngIf="postForm.get('tipo')?.touched && postForm.get('tipo')?.invalid" class="text-danger small mt-1">
            <div *ngIf="postForm.get('tipo')?.errors?.['required']">
              El tipo es obligatorio.
            </div>
          </div>
        </div>

        <!-- Imágenes -->
        <div class="mb-3">
          <label class="form-label fw-bold">Imágenes (máx. 5, subidas a Cloudinary)</label>
          <input class="form-control" type="file" (change)="onFileChange($event)" multiple accept="image/*" />
          <div class="form-text">Las imágenes se subirán automáticamente a Cloudinary. Puedes seleccionar hasta 3 imágenes.</div>
          <div class="mt-2 d-flex gap-2">
            <div *ngFor="let img of imagenesPreview; let i = index" style="position:relative;">
              <img [src]="img" style="max-width: 150px; max-height: 150px; border:1px solid #00aaff; border-radius: 8px;">
              <button type="button" (click)="eliminarImagen(i)" style="position:absolute;top:2px;right:2px;" class="btn btn-sm btn-danger">×</button>
              <select class="form-select mt-2"
                      [value]="rolesImagenes[i]"
                      (change)="onRolChange(i, $event)"
                      name="rolImagen{{i}}">
                <option value="miniatura" [disabled]="rolesImagenes.includes('miniatura') && rolesImagenes[i] !== 'miniatura'">Miniatura</option>
                <option value="portada" [disabled]="rolesImagenes.includes('portada') && rolesImagenes[i] !== 'portada'">Portada</option>
                <option value="contenido1" [disabled]="rolesImagenes.includes('contenido1') && rolesImagenes[i] !== 'contenido1'">Imagen de contenido 1</option>
                <option value="contenido2" [disabled]="rolesImagenes.includes('contenido2') && rolesImagenes[i] !== 'contenido2'">Imagen de contenido 2</option>
                <option value="contenido3" [disabled]="rolesImagenes.includes('contenido3') && rolesImagenes[i] !== 'contenido3'">Imagen de contenido 3</option>
              </select>
            </div>
          </div>
          <div *ngIf="postForm.errors?.['imagenesRequired'] && postForm.touched" class="text-danger small mt-1">
            Debes subir al menos una imagen.
          </div>
        </div>

        <div class="d-flex justify-content-between align-items-center mt-4">
          <button type="submit" class="btn btn-primary px-4"
            [disabled]="postForm.invalid || subiendoImagen || imagenesIds.length !== imagenes.length">
            {{ modoEdicion ? 'Guardar cambios' : 'Crear post' }}
          </button>
          <button *ngIf="modoEdicion" type="button" class="btn btn-danger ms-2" (click)="onDelete()">
            Eliminar post
          </button>
        </div>
      </form>

      <div *ngIf="errorMsg" class="alert alert-danger mt-3">{{ errorMsg }}</div>
    </div>
  </div>
</div>

<style>
/* Neutro: gris muy claro */
.post-bg {
  background: #f5f6fa !important;
}

/* Electric blue border for the card */
.post-card {
  border-radius: 1.2rem !important;
  border: 3px solid #00aaff !important;
  background: #fff;
}
</style>
